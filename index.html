<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <title></title>
</head>
<body>

    <div id="J_iAddress"></div>

    

<script src="https://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
<script>

    // 1   将json数据渲染为dom结构
    // 2   给select绑定事件处理程序
    // 3   事件被触发时，执行回调，将选择的结果传递给回调
    var level = 0, init, render, createDom, getJsonFromData,
        clearAfterSelect,
        $iAddress;
    
    var cacheData = null;
    var count = 0;

    $iAddress = $('#J_iAddress');

    render = function(data){
        level++;
        var html = `<select data-level="${level}"><option value="">请选择</option>`;
            
        html += data.map(function(item, index){
            return `<option value="${ item.code }">${ item.name }</option>`;
        }).join('');

        html += `</select>`;

        return html;
    };

    // 做优化
        // 比如选了湖北省 那么再选湖北省下面的省市的话，则不需要遍历其他省了
    getJsonFromData = function(data, code){
        count++;
        for(var i = 0; i < data.length; i++){      
            if(data[i].code === code){
                return data[i].children;
            }else{
                if(data[i].children){
                   var res = getJsonFromData(data[i].children, code);
                   if(res){
                       return res;
                   }
                }
            }
        }
    };

    // level参数是当前触发select元素的等级
    clearAfterSelect = function(_level){
        $('select').each((index, item) => {
            if($(item).attr('data-level') > _level){
                $(item).remove();
            }
        });

        level = _level;
    };

    init = function(data){

        // 生成省份
        $iAddress.append(render(data));

        $iAddress.on('change', 'select', function(e){
            var code = e.target.value;
            var _level = parseInt(e.target.getAttribute('data-level'));
            
            if(_level < level){
                clearAfterSelect(_level);
            }

            if(!code || !data || !data.length){return;}

            // 这里还需要做一下判断，当选择的下级有了之后，就应该清除之前选的

            // 怎么判断呢？
            //     每次生成一个select就给他加一个层级，然后每次生成前就在事件处理程序中读取当前select
            // 的层级，如果层级有问题就remove掉

            // 是否可以利用这个层级变量来优化查找？
            //     如果当前的level是2，那么就应该在市里面去遍历
            //     如果当前的level是3，那么就应该是区域里面去遍历
            
            //     应该是在当前code的子元素里面去遍历

            // 难道只能做缓存，比如当前选了一个湖北省，那就把湖北省的子元素都缓存起来
            // 下一次选的项目是湖北省的子元素的话，就在这个缓存里面去搜索，这样速度会快些
            
            var result = null;
            if(cacheData && (_level > 1)){
                result = getJsonFromData(cacheData, code);
            }else{
                // 这里只缓存了选择的市列表 还可以继续优化，让每次选择只从子元素中找，不用找同级
                result = cacheData = getJsonFromData(data, code);
            }
            if(!result){return;}
            $iAddress.append(render(result));
        });
    };

    $.getJSON('./pcas-code.json').then(function(data){
        if(data && data.length){
            init(data);
        }
    }, function(error){
        alert('地址数据异常');
    });

</script>
</body>
</html>
        